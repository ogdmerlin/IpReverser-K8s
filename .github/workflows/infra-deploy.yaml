# ---
# name: Infrastucture Deployment DO
# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main
# permissions:
#   id-token: write
# jobs:
#   terraform:
#     name: Deploy Infrastructure
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#       - name: Configure DigitalOcean Credentials
#         env:
#           DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

#         run: |
#           echo "Configuring DigitalOcean credentials..."
#           export DIGITALOCEAN_TOKEN="$DIGITALOCEAN_TOKEN"

#       - name: Configure Spaces Credentials
#         env:
#           AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           AWS_DEFAULT_REGION: sf03
#         run: |
#           echo "Configuring Spaces credentials..."

#       - name: Install Terraform
#         uses: hashicorp/setup-terraform@v3
#         with:
#           terraform_version: 1.10.5
#       - name: Change Directory to Infrastructure
#         run: cd ./K8s_Infra
#       - name: Terraform Init
#         run: |
#           cd ./K8s_Infra
#           terraform init

#       - name: Terraform Validate
#         run: |
#           cd ./K8s_Infra
#           terraform validate

#       - name: Terraform Plan
#         env:
#           TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
#         run: |
#           cd ./K8s_Infra
#           terraform plan

#       - name: Apply and Save Terraform State
#         run: |
#           cd ./K8s_Infra
#           terraform apply --auto-approve

name: Infrastucture Deployment DO
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
permissions:
  id-token: write
jobs:
  terraform:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Configure DigitalOcean Credentials
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          echo "Configuring DigitalOcean credentials..."
          export DIGITALOCEAN_TOKEN="$DIGITALOCEAN_TOKEN"
      - name: Configure Spaces Credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: sf03
        run: |
          echo "Configuring Spaces credentials..."
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.5
      - name: Change Directory to Infrastructure
        run: cd ./K8s_Infra
      - name: Terraform Init
        run: |
          cd ./K8s_Infra
          terraform init
      - name: Terraform Validate
        run: |
          cd ./K8s_Infra
          terraform validate
      - name: Terraform Plan
        run: |
          cd ./K8s_Infra
          echo "TF_VAR_do_token=$DIGITALOCEAN_TOKEN" >> $GITHUB_ENV
          terraform plan
          terraform plan -var do_token=$TF_VAR_do_token
      - name: Apply and Save Terraform State
        run: |
          cd ./K8s_Infra
          terraform apply --auto-approve